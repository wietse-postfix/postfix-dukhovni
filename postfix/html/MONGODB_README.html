<!doctype html public "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Postfix MongoDB Howto</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<h1><img src="postfix-logo.jpg" width="203" height="98" ALT="">Postfix MongoDB Howto</h1>
<hr>

<h2>MongoDB Support in Postfix</h2>

<p> Postfix can use MongoDB as a source for any of its lookups:
<a href="aliases.5.html">aliases(5)</a>, <a href="virtual.5.html">virtual(5)</a>, <a href="canonical.5.html">canonical(5)</a>, etc. This allows you to keep
information for your mail service in a replicated noSQL database
with fine-grained access controls. By not storing it locally on the
mail server, the administrators can maintain it from anywhere, and
the users can control whatever bits of it you think appropriate.
You can have multiple mail servers using the same information,
without the hassle and delay of having to copy it to each. </p>

<p> Topics covered in this document:</p>

<ul>
<li><a href="#build">Building Postfix with MongoDB support</a>
<li><a href="#config">Configuring MongoDB lookups</a>
<li><a href="#example_virtual">Example: virtual alias maps</a>
<li><a href="#example_mailing_list">Example: Mailing lists</a>
<li><a href="#example_projections">Example: MongoDB projections</a>
<li><a href="#feedback">Feedback</a>
</ul>

<h2><a name="build">Building Postfix with MongoDB support</a></h2>

<p>These instructions assume that you build Postfix from source
code as described in the <a href="INSTALL.html">INSTALL</a> document. Some modification may
be required if you build Postfix from a vendor-specific source
package. </p>

<p>The Postfix MongoDB client requires the mongo-c-driver library.
This can be built from source code from <a
href="https://github.com/mongodb/mongo-c-driver/releases">the
mongod-c project</a>, or as a binary package from your OS distribution,
typically named <b>mongo-c-driver-devel</b> or <b>libmongoc-dev</b>.
</p>

<p>In order to build Postfix with mongodb map support, you will
need to add -DHAS_MONGODB and -I for the directory containing the
mongodb headers, the libmongoc-1.0 and libbson-1.0 libraries to
<a href="MONGODB_README.html">AUXLIBS_MONGODB</a>, for example:</p>

<blockquote>
<pre>
% make tidy
% make -f Makefile.init makefiles \
    CCARGS="$CCARGS -DHAS_MONGODB -I/usr/include/libmongoc-1.0 \
    -I/usr/include/libbson-1.0" \
    <a href="MONGODB_README.html">AUXLIBS_MONGODB</a>="-lmongoc-1.0 -lbson-1.0"
</pre>
</blockquote>

<p>The 'make tidy' command is needed only if you have previously
built Postfix without MongoDB support. </p>

<p>If your MongoDB shared library is in a directory that the RUN-TIME
linker does not know about, add a "-Wl,-R,/path/to/directory" option
after "-lbson-1.0". Then, just run 'make'.</p>

<h2><a name="config">Configuring MongoDB lookups</a></h2>

<p> In order to use MongoDB lookups, define a MongoDB source as a
table lookup in <a href="postconf.5.html">main.cf</a>, for example: </p>

<blockquote>
<pre>
<a href="postconf.5.html#alias_maps">alias_maps</a> = <a href="DATABASE_README.html#types">hash</a>:/etc/aliases, <a href="proxymap.8.html">proxy</a>:mongodb:/etc/postfix/mongo-aliases.cf
</pre>
</blockquote>

<p> The file /etc/postfix/mongo-aliases.cf can specify a number of
parameters. For a complete description, see the mongodb_table(5)
manual page. </p>

<h2><a name="example_virtual">Example: virtual(5) alias maps</a></h2>

<p> Here's a basic example for using MongoDB to look up <a href="virtual.5.html">virtual(5)</a>
aliases. Assume that in <a href="postconf.5.html">main.cf</a>, you have: </p>

<blockquote> 
<pre>
<a href="postconf.5.html#virtual_alias_maps">virtual_alias_maps</a> = <a href="DATABASE_README.html#types">hash</a>:/etc/postfix/virtual_aliases, 
    <a href="proxymap.8.html">proxy</a>:mongodb:/etc/postfix/mongo-virtual-aliases.cf
</pre>
</blockquote> 

<p> and in mongodb:/etc/postfix/mongo-virtual-aliases.cf you have: </p>

<blockquote> 
<pre>
uri = mongodb+srv://user_name:password@some_server
dbname = mail
collection = mailbox
filter = {"$$or": [{"username":"%s"}, {"alias.address": "%s"}], "active": 1}
result_attribute = username
</pre>
</blockquote> 

<p>This example assumes mailbox names are stored in a MongoDB backend,
in a format like:</p>

<blockquote> 
<pre>
{ "username": "user@example.com", "alias": [ "admin@example.com", "abuse@example.com" ] }
</pre>
</blockquote> 

<p>Upon receiving mail for "admin@example.com" that isn't found in the
/etc/postfix/virtual_aliases database, Postfix will search the
MongoDB server/cluster listening at port 27017 on some_server. It
will connect using the provided credentials, and search for any
entries whose username is, or alias field has "admin@example.com".
It will return the username attribute of those found, and build a
list of their email addresses. </p>

<h2><a name="example_mailing_list">Example: Mailing lists</a></h2>

<p>When it comes to mailing lists, one way of implementing one would
be as below:</p>

<blockquote> 
<pre>
{ "name": "dev@example.com", "active": 1, "address": 
  [ "hamid@example.com", "wietse@example.com", "viktor@example.com" ] }
</pre>
</blockquote> 

<p>using the filter below, will result in a comma separated string
with all email addresses in this list. </p>

<blockquote> 
<pre>
filter = {"name": "%s", "active": 1}
return_attribute = address
</pre>
</blockquote> 

<h2><a name="example_projections">Example: advanced projections</a></h2>

<p>This module also supports the use of more complex MongoDB
projections.  There may be some use cases where operations such as
concatenation are necessary to be performed on the data retrieved
from the database. Although it is encouraged to keep the database
design simple enough so this is not necessary, postfix supports the
use of MongoDB projections to achieve the goal. </p>

<p>Consider the example below:</p>

<blockquote> 
<pre>
{ "username": "user@example.com", "local_part": "user", "domain": "example.com", "alias": [ "admin@example.com", "abuse@example.com" ] }
</pre>
</blockquote> 

<p><a href="postconf.5.html#virtual_mailbox_maps">virtual_mailbox_maps</a> can be created using below parameters ina
a mongodb:/etc/postfix/mongo-virtual-mailboxes.cf file:</p>

<blockquote> 
<pre>
uri = mongodb+srv://user_name:password@some_server
dbname = mail
collection = mailbox
filter = {"$$or": [{"username":"%s"}, {"alias.address": "%s"}], "active": 1}
projection = { "_id": 0, "mail_path": 
  {"$$concat": ["$$domain", "/", "$$local_part"]} }
</pre>
</blockquote> 

<p>This will return 'example.com/user' path built from the database fields. </p>

<p>A couple of considerations when using projections:</p>

<ul>

<li><p>The '_id' field is always returned as part of the result set
by MongoDB. It should be excluded from the result in the projection.
This is done automatically when <b>result_attribute</b> is used.
</p></li>

<li><p>When a query produces multiple results (separated by comma),
the Postfix implementation will only parse fields with data types
UTF8, INT32, INT64 and ARRAY. Other fields will generate a warning
in the logs, and will be ignored. It is suggested to exclude any
unnecessary fields when using the projections. </p></li>

</ul>
<h2><a name="feedback">Feedback</a></h2>

<p> If you have questions, send them to postfix-users@postfix.org.
Please include relevant information about your Postfix setup:
MongoDB-related output from postconf, which libraries you built
with, and such. If your question involves your database contents,
please include the applicable bits of some database entries. </p>

</body>

</html>
